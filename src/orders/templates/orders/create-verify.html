{% extends "base.html" %}

{% load currency_vnd %}
{% load static %}

{% block title %}
Tạo đơn
{% endblock title %}

{% block navigation %}
{% include "navigation.html" with path='order' %}
{% endblock navigation %}

{% block main %}
<div class="container my-5 border rounded shadow-sm p-4 bg-body-tertiary order-container">
  <form method="post">
    {% csrf_token %}
    <input type="hidden" name="buyer_phone_number" value="{{form.buyer_phone_number.value}}">
    <input type="hidden" name="device_id" value="{{form.device_id.value}}">
    <input type="hidden" name="is_receive_in_store" value="{{form.is_receive_in_store.value}}">
    <input type="hidden" name="address" value="{{form.address.value|default:''}}">
    <input type="hidden" name="payment_method" value="{{form.payment_method.value}}">

    <div class="mb-3">
      <div class="badge text-bg-primary me-2">
        {% if form.is_receive_in_store.value %}
        <i class="fa-solid fa-store"></i>
        Nhận tại cửa hàng
        {% else %}
        <i class="fa-solid fa-truck-fast"></i>
        Giao hàng tận nhà
        {% endif %}
      </div>

      <div class="badge text-bg-secondary">
        {% if form.payment_method.value == 'cash' %}
        <i class="fa-solid fa-money-bill"></i>
        Tiền mặt
        {% else %}
        <i class="fa-solid fa-qrcode"></i>
        Chuyển khoản
        {% endif %}
      </div>
    </div>

    <div class="mb-5">
      <span class="fw-semibold">Địa chỉ nhận hàng:</span>
      {{ form.address.value|default:'Không có!' }}
    </div>

    {% if form.buyer %}
    <div class="alert alert-primary mb-3" role="alert">
      <div class="row">
        <div class="col fw-semibold buyer_info__title">Số điện thoại:</div>
        <div class="col">{{ form.buyer.phone_number }}</div>
      </div>
      <div class="row">
        <div class="col fw-semibold buyer_info__title">Khách hàng:</div>
        <div class="col">{{ form.buyer.get_full_name }}</div>
      </div>
    </div>
    {% else %}
    <div class="alert alert-warning" role="alert">
      <div class="row">
        <div class="col fw-semibold buyer_info__title">Số điện thoại:</div>
        <div class="col">{{ form.buyer_phone_number.value }}</div>
      </div>
      Khách hàng chưa đăng ký!!!
    </div>
    {% endif %}

    {% if form.buyer %}
    <div>
      <i class="fa-solid fa-coins me-1"></i>
      Khách hàng có <span class="fw-semibold">{{form.buyer.points|floatformat:0}}</span> điểm
    </div>
    <div class="form-check form-switch">
      <input class="form-check-input" type="checkbox" role="switch" id="isUsePoint" checked name="is_use_point">
      <label class="form-check-label" for="isUsePoint">Sử dụng điểm</label>
    </div>
    {% endif %}

    <div class="mb-5 d-flex mt-5">
      <div class="me-3">
        <img class="rounded"
          src="{% if form.device.product.thumbnail_image %}{{ form.device.product.thumbnail_image.url }}{% else %}{% static 'imgs/default_product.png' %}{% endif %}"
          alt="Hình ảnh sản phẩm" width="70" height="70">
      </div>
      <div class="d-flex flex-column justify-content-end">
        <h5>{{ form.device.product.name }} - {{ form.device.product.price|currency_vnd }}</h5>
        <div><code>{{ form.device.get_format_id }}</code></div>
      </div>
    </div>

    <hr>

    <div class="text-end mb-5 text-danger">
      <h3>Tổng số tiền: <span id="orderPrice"></span></h3>
    </div>

    <div class="text-end">
      <button type="submit" class="btn btn-outline-secondary me-2" name="action" value="back">
        <i class="fa-solid fa-arrow-left"></i>
        Quay lại
      </button>
      <button type="submit" class="btn btn-primary" name="action" value="create-order">
        <i class="fa-solid fa-pen"></i>
        Tạo đơn
      </button>
    </div>
  </form>
</div>
{% endblock main %}

{% block footer %}
{% endblock footer %}

{% block style %}
<style>
  .order-container {
    max-width: 500px;
  }

  .buyer_info__title {
    max-width: 10rem;
  }
</style>
{% endblock style %}

{% block script %}
<script>
  const orderPriceEl = document.querySelector('#orderPrice')
  const isUsePointEl = document.querySelector('#isUsePoint')
  const productPrice = Number('{{ form.device.product.price }}'.replace(',', '.'))
  const buyerPoint = Number('{{ form.buyer.points }}'.replace(',', '.'))

  const updateOrderPrice = () => {
    let orderPrice = isUsePointEl?.checked ? productPrice - buyerPoint : productPrice
    orderPriceEl.textContent = currencyVND(orderPrice)
  }
  updateOrderPrice()

  isUsePointEl && isUsePointEl.addEventListener('change', updateOrderPrice)

</script>
{% endblock script %}
